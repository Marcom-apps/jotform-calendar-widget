<!DOCTYPE html>
<html>
<head>
  <title>Powerco Calendar Widget</title>
  <link rel="stylesheet" href="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #calendar { width: 100%; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>

  <!-- Updated input with correct target class -->
  <input id="calendar" type="text" class="js-requested-date" readonly="readonly">

  <!-- Load Flatpickr library -->
  <script src="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

  <!-- Calendar initialization script -->
  <script>
    const params = new URLSearchParams(window.location.search);

    const noticeDays = parseInt(params.get("noticeDays") || "5", 10);
    const cutoffHour = parseInt(params.get("cutoffHour") || "8", 10);
    const targetFieldClass = params.get("targetFieldClass") || ".js-requested-date";

    const holidayDates = (params.get("holidayDates") || "")
      .split(",")
      .map(dateStr => new Date(dateStr.trim()))
      .filter(date => !isNaN(date));

    Date.prototype.addDays = function (days) {
      const date = new Date(this.valueOf());
      date.setDate(date.getDate() + days);
      return date;
    };

    function isWeekend(date) {
      return date.getDay() === 0 || date.getDay() === 6;
    }

    function isHoliday(date) {
      return holidayDates.some(h => h.toDateString() === date.toDateString());
    }

    function isTooEarly(date) {
      return date.setHours(0, 0, 0, 0) < earliestPickableDate.setHours(0, 0, 0, 0);
    }

    let earliestPickableDate = new Date();
    const nowHour = new Date().getHours();
    let workingDaysToAdd = nowHour < cutoffHour ? noticeDays : noticeDays + 1;
    let workingDaysAdded = 0;

    while (workingDaysAdded < workingDaysToAdd) {
      const nextDate = earliestPickableDate.addDays(1);
      if (!isWeekend(nextDate) && !isHoliday(nextDate)) {
        workingDaysAdded++;
      }
      earliestPickableDate = nextDate;
    }

    window.addEventListener('load', function () {
      flatpickr(targetFieldClass, {
        altFormat: 'd/m/Y',
        altInput: true,
        defaultDate: earliestPickableDate,
        disable: [isWeekend, isHoliday, isTooEarly],
        locale: {
          firstDayOfWeek: 1
        }
      });
    });
  </script>

</body>
</html>
