<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    #calendar { width: 100%; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <!-- Default input field -->
  <input id="calendar" type="text" class="flatpickr-input" readonly="readonly">

  <script src="https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script>
    function getWidgetSetting(name, fallback = "") {
      try {
        const raw = window.frameElement?.getAttribute("data-" + name);
        return raw !== null ? raw : fallback;
      } catch {
        return fallback;
      }
    }

    const noticeDays = parseInt(getWidgetSetting("noticedays", "5"), 10);
    const cutoffHour = parseInt(getWidgetSetting("cutoffhour", "8"), 10);
    const holidayDatesRaw = getWidgetSetting("holidaydates", "");
    const defaultDateOffset = parseInt(getWidgetSetting("defaultdateoffset", "0"), 10);

    // Try to use custom selector if provided, fallback to our default field
    const targetFieldClass = getWidgetSetting("targetfieldclass", "#calendar") || "#calendar";

    const holidayDates = holidayDatesRaw
      .split(",")
      .map(dateStr => new Date(dateStr.trim()))
      .filter(date => !isNaN(date));

    Date.prototype.addDays = function (days) {
      const date = new Date(this.valueOf());
      date.setDate(date.getDate() + days);
      return date;
    };

    function isWeekend(date) {
      return date.getDay() === 0 || date.getDay() === 6;
    }

    function isHoliday(date) {
      return holidayDates.some(h => h.toDateString() === date.toDateString());
    }

    function isTooEarly(date) {
      return date.setHours(0, 0, 0, 0) < earliestPickableDate.setHours(0, 0, 0, 0);
    }

    let earliestPickableDate = new Date();
    const nowHour = new Date().getHours();
    let workingDaysToAdd = nowHour < cutoffHour ? noticeDays : noticeDays + 1;
    let workingDaysAdded = 0;

    while (workingDaysAdded < workingDaysToAdd) {
      const nextDate = earliestPickableDate.addDays(1);
      if (!isWeekend(nextDate) && !isHoliday(nextDate)) {
        workingDaysAdded++;
      }
      earliestPickableDate = nextDate;
    }

    if (defaultDateOffset > 0) {
      earliestPickableDate = earliestPickableDate.addDays(defaultDateOffset);
    }

    window.addEventListener('load', function () {
      const targetField = document.querySelector(targetFieldClass);
      if (!targetField) {
        console.warn(`No element found for selector: ${targetFieldClass}`);
        return;
      }

      flatpickr(targetField, {
        altFormat: 'd/m/Y',
        altInput: true,
        defaultDate: earliestPickableDate,
        disable: [isWeekend, isHoliday, isTooEarly],
        locale: {
          firstDayOfWeek: 1
        }
      });
    });
  </script>
</body>
</html>
