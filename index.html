<script>
  // Read widget settings from the URL
  const params = new URLSearchParams(window.location.search);

  const noticeDays = parseInt(params.get("noticeDays") || "5", 10); // default to 5
  const cutoffHour = parseInt(params.get("cutoffHour") || "8", 10); // default to 8AM
  const targetFieldClass = params.get("targetFieldClass") || ".js-requested-date";

  const holidayDates = (params.get("holidayDates") || "")
    .split(",")
    .map(dateStr => new Date(dateStr.trim()))
    .filter(date => !isNaN(date));

  // Utility to add working days
  Date.prototype.addDays = function (days) {
    const date = new Date(this.valueOf());
    date.setDate(date.getDate() + days);
    return date;
  };

  function isWeekend(date) {
    return date.getDay() === 0 || date.getDay() === 6;
  }

  function isHoliday(date) {
    return holidayDates.some(h => h.toDateString() === date.toDateString());
  }

  function isTooEarly(date) {
    return date.setHours(0, 0, 0, 0) < earliestPickableDate.setHours(0, 0, 0, 0);
  }

  let earliestPickableDate = new Date();
  const nowHour = new Date().getHours();
  let workingDaysToAdd = nowHour < cutoffHour ? noticeDays : noticeDays + 1;
  let workingDaysAdded = 0;

  while (workingDaysAdded < workingDaysToAdd) {
    const nextDate = earliestPickableDate.addDays(1);
    if (!isWeekend(nextDate) && !isHoliday(nextDate)) {
      workingDaysAdded++;
    }
    earliestPickableDate = nextDate;
  }

  window.addEventListener('load', function () {
    flatpickr(targetFieldClass, {
      altFormat: 'd/m/Y',
      altInput: true,
      defaultDate: earliestPickableDate,
      disable: [isWeekend, isHoliday, isTooEarly],
      locale: {
        firstDayOfWeek: 1
      }
    });
  });
</script>
